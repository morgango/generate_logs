# Elasticsearch Grok Patterns for Log Parsing

This document provides Grok patterns for parsing all log formats generated by this tool, conforming to Elastic Common Schema (ECS).

## Format Overview

| Format | Identifier | Grok Pattern | ECS Fields |
|--------|------------|--------------|------------|
| Apache | File path | Apache HTTP Access | `@timestamp`, `client.ip`, `http.request.method`, `http.response.status_code` |
| CSV | File path | Comma-delimited | `@timestamp`, `log.level`, `service.name` |
| PIPE | File path | Pipe-delimited + key=value | `@timestamp`, `log.level`, `service.name`, `transaction.id` |
| KV | File path | Key=value pairs | `@timestamp`, `log.level`, `service.name`, `http.request.id` |
| Hadoop | File path | Space-delimited system logs | `@timestamp`, `log.level`, `host.name`, `process.name` |
| Logstash | File path | Semi-colon delimited | `@timestamp`, `log.level`, `service.name`, `user.id` |
| NGINX | File path | HTTP Access (NGINX) | `@timestamp`, `client.ip`, `http.request.method`, `http.response.status_code` |
| Tomcat | File path | Java Application | `@timestamp`, `log.level`, `process.name`, `log.origin.thread` |
| MySQL | File path | Database Query | `@timestamp`, `user.name`, `database.name`, `db.query` |
| Redis | File path | Cache/Database | `@timestamp`, `log.level`, `process.pid`, `service.role` |
| Syslog | File path | Structured syslog with custom data | `@timestamp`, `log.level`, `host.name`, `process.name`, `http.request.id` |

## Grok Patterns

## Generic access
```
fmt=%{WORD:custom.type}\s+%{GREEDYDATA:custom.message}
```

### 1. Apache HTTP Access Logs
```
%{IPV4:client.ip}\s+%{DATA:custom.ident}\s+%{DATA:custom.auth}\s+\[(?<apache.time>%{MONTHDAY}/%{MONTH}/%{YEAR}:%{TIME})(?: %{INT})?\s*\]\s+"%{WORD:http.request.method}\s+%{DATA:http.request.uri.original}\s+%{DATA:http.version}"\s+%{NUMBER:http.response.status_code:int}\s+%{NUMBER:http.response.bytes:int}\s+"%{DATA:http.request.referrer}"\s+"%{DATA:user_agent.original}"\s+%{NUMBER:http.response.duration:float}\s+%{GREEDYDATA:custom.messsage}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `client.ip` ← `client.ip`
- `http.request.method` ← `http.request.method`
- `http.request.uri.original` ← `http.request.uri.original`
- `http.response.status_code` ← `http.response.status_code`
- `http.response.bytes` ← `http.response.bytes`
- `http.request.referrer` ← `http.request.referrer`
- `user_agent.original` ← `user_agent.original`
- `event.duration` ← `event.duration`
- `custom.service.name` ← `custom.service.name`
- `custom.ident` ← `custom.ident`
- `custom.auth` ← `custom.auth`

### 2. CSV Format
```
%{TIMESTAMP_ISO8601:custom.timestamp},%{WORD:log.level},%{DATA:service.name},%{DATA:user.id},%{NUMBER:event.duration:int},%{NUMBER:http.response.status_code:int},%{GREEDYDATA:custom.message}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `log.level` ← `log.level`
- `service.name` ← `service.name`
- `user.id` ← `user.id`
- `event.duration` ← `event.duration`
- `http.response.status_code` ← `http.response.status_code`
- `custom.message` ← `custom.message`
- `custom.type` ← `custom.type`

### 3. PIPE Format
```
%{TIMESTAMP_ISO8601:custom.timestamp}\|%{WORD:log.level}\|%{DATA:service.name}\|txn=%{DATA:transaction.id}\|amount=%{NUMBER:transaction.amount:float}\|country=%{WORD:client.geo.country_iso_code}\|session=%{DATA:session.id}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `log.level` ← `log.level`
- `service.name` ← `service.name`
- `transaction.id` ← `transaction.id`
- `transaction.amount` ← `transaction.amount`
- `client.geo.country_iso_code` ← `client.geo.country_iso_code`
- `session.id` ← `session.id`
- `custom.type` ← `custom.type`

### 4. KV Format
```
ts=%{TIMESTAMP_ISO8601:custom.timestamp} level=%{WORD:log.level} service=%{DATA:service.name} req=%{DATA:http.request.id} duration_ms=%{NUMBER:event.duration_ms:int} msg=%{GREEDYDATA:custom.message}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `log.level` ← `log.level`
- `service.name` ← `service.name`
- `http.request.id` ← `http.request.id`
- `event.duration_ms` ← `event.duration_ms`
- `custom.message` ← `custom.message`
- `custom.type` ← `custom.type`

### 5. Hadoop Format
```
%{TIMESTAMP_ISO8601:custom.timestamp} %{WORD:log.level} %{WORD:process.name} %{IPORHOST:hadoop.host.name} %{NOTSPACE:hadoop.job.id} %{NOTSPACE:hadoop.task.id}\s+memory=%{NUMBER:hadoop.task.memory_mb:int}\s+cpu=%{NUMBER:hadoop.task.cpu_cores:int}\s+duration=%{NUMBER:event.duration_ms:int}\s%{GREEDYDATA:custom.message}
```


**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `log.level` ← `log.level`
- `process.name` ← `process.name`
- `hadoop.host.name` ← `hadoop.host.name`
- `hadoop.job.id` ← `hadoop.job.id`
- `hadoop.task.id` ← `hadoop.task.id`
- `hadoop.task.memory_mb` ← `hadoop.task.memory_mb`
- `hadoop.task.cpu_cores` ← `hadoop.task.cpu_cores`
- `event.duration_ms` ← `event.duration_ms`
- `custom.message` ← `custom.message`
- `custom.type` ← `custom.type`

### 6. Logstash Format
```
@timestamp=%{TIMESTAMP_ISO8601:custom.timestamp};\s+level=%{WORD:log.level};\s+service=%{NOTSPACE:custom.service.name};\s+request_id=%{NOTSPACE:http.request.id};\s+session_id=%{NOTSPACE:session.id};\s+user_id=%{NOTSPACE:user.id};\s+duration_ms=%{NUMBER:event.duration_ms:int};\s+status_code=%{NUMBER:http.response.status_code:int};\s+ip=%{IP:client.ip};\s+user_agent=%{DATA:user_agent.original};\s+message=%{GREEDYDATA:custom.message}$
```



**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `log.level` ← `log.level`
- `custom.service.name` ← `custom.service.name`
- `http.request.id` ← `http.request.id`
- `session.id` ← `session.id`
- `user.id` ← `user.id`
- `event.duration_ms` ← `event.duration_ms`
- `http.response.status_code` ← `http.response.status_code`
- `client.ip` ← `client.ip`
- `user_agent.original` ← `user_agent.original`
- `custom.message` ← `custom.message`
- `custom.type` ← `custom.type`

### 7. NGINX Format
```
%{IPV4:client.ip}\s+%{DATA:custom.ident}\s+%{DATA:custom.auth}\s+\[(?<custom.timestamp>%{MONTHDAY}/%{MONTH}/%{YEAR}:%{TIME})(?: %{INT})?\s*\]\s+"%{WORD:http.request.method} %{DATA:http.request.uri.original} %{DATA:http.version}"\s+%{NUMBER:http.response.status_code:int}\s+%{NUMBER:http.response.bytes:int}\s+"%{DATA:http.request.referrer}"\s+"%{DATA:user_agent.original}"\s+rt=%{NUMBER:event.duration:float}\s+upstream=%{GREEDYDATA:custom.service.name}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `client.ip` ← `client.ip`
- `http.request.method` ← `http.request.method`
- `http.request.uri.original` ← `http.request.uri.original`
- `http.response.status_code` ← `http.response.status_code`
- `http.response.bytes` ← `http.response.bytes`
- `http.request.referrer` ← `http.request.referrer`
- `user_agent.original` ← `user_agent.original`
- `event.duration` ← `event.duration`
- `custom.service.name` ← `custom.service.name`
- `custom.ident` ← `custom.ident`
- `custom.auth` ← `custom.auth`
- `custom.type` ← `custom.type`

### 8. Tomcat Format
```
%{TIMESTAMP_ISO8601:custom.timestamp}\s+%{WORD:log.level}\s+%{NOTSPACE:process.name}\s+%{NOTSPACE:log.origin.thread}\s+%{GREEDYDATA:custom.message}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `log.level` ← `log.level`
- `process.name` ← `process.name`
- `log.origin.thread` ← `log.origin.thread`
- `custom.message` ← `custom.message`
- `custom.type` ← `custom.type`

### 9. MySQL Format
```
%{TIMESTAMP_ISO8601:custom.timestamp} %{DATA:user.name}\[%{DATA:user.name}\] @ %{IPORHOST:host.ip} \[%{TIMESTAMP_ISO8601:query_timestamp}\] %{NUMBER:event.duration:float} %{NUMBER:lock_time:float} %{NUMBER:db.rows_sent:int} %{NUMBER:db.rows_examined:int} %{DATA:db.name} %{GREEDYDATA:db.query}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `user.name` ← `user.name`
- `host.ip` ← `host.ip`
- `query_timestamp` ← `query_timestamp`
- `event.duration` ← `event.duration`
- `lock_time` ← `lock_time`
- `db.rows_sent` ← `db.rows_sent`
- `db.rows_examined` ← `db.rows_examined`
- `db.name` ← `db.name`
- `db.query` ← `db.query`
- `custom.type` ← `custom.type`

### 10. Redis Format
```
%{TIMESTAMP_ISO8601:custom.timestamp} %{WORD:log.level} %{NUMBER:process.pid:int}:%{DATA:process_type} %{DATA:service.role} %{GREEDYDATA:custom.message}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `log.level` ← `log.level`
- `process.pid` ← `process.pid`
- `process_type` ← `process_type`
- `service.role` ← `service.role`
- `custom.message` ← `message`
- `custom.type` ← `custom.type`

### 11. Syslog Format (RFC 5424)
```
SYSLOG_RFC5424 <%{NUMBER:syslog.priority:int}>%{NUMBER:syslog.version:int} %{TIMESTAMP_ISO8601:custom.timestamp} %{IPORHOST:host.name} %{NOTSPACE:process.name} %{NUMBER:process.pid:int} - \[%{NOTSPACE:syslog.structured_data_id}@%{NUMBER:syslog.enterprise_id:int} service="%{DATA:service.name}" request_id="%{DATA:http.request.id}" session_id="%{DATA:session.id}" user_id="%{DATA:user.id}" duration_ms="%{NUMBER:event.duration_ms:int}" status_code="%{NUMBER:http.response.status_code:int}" client_ip="%{IP:client.ip}"\] %{GREEDYDATA:custom.message}
```

**Direct ECS Field Extraction:**
- `@timestamp` ← `custom.timestamp`
- `host.name` ← `host.name`
- `process.name` ← `process.name`
- `process.pid` ← `process.pid`
- `service.name` ← `service.name`
- `http.request.id` ← `http.request.id`
- `session.id` ← `session.id`
- `user.id` ← `user.id`
- `event.duration_ms` ← `event.duration_ms`
- `http.response.status_code` ← `http.response.status_code`
- `client.ip` ← `client.ip`
- `custom.message` ← `custom.message`
- `syslog.priority` ← `syslog.priority`
- `syslog.version` ← `syslog.version`
- `syslog.structured_data_id` ← `syslog.structured_data_id`
- `syslog.enterprise_id` ← `syslog.enterprise_id`

**Example Syslog Message:**
```
SYSLOG_RFC5424 <166>1 2023-12-25T10:30:45.123Z app-3.cluster.local loggen-checkout 12345 - [app@12345 service="checkout" request_id="req-a1b2c3d4" session_id="sess-e5f6g7h8i9j0" user_id="user-1234" duration_ms="250" status_code="200" client_ip="10.1.2.3"] User initiated checkout process
```

## Usage Notes

1. **Format Identification**: Each format is written to its own file (e.g., `loadgen_apache.log`, `loadgen_csv.log`, etc.)
2. **ECS Compliance**: All fields map to standard ECS field names
3. **Data Types**: Proper type casting for numbers, dates, and IPs
4. **Flexibility**: Patterns handle variations in log formats
5. **Performance**: Optimized for high-volume log processing
6. **Syslog Special**: The syslog format follows RFC 5424 standard with structured data for enhanced parsing
7. **File-based Filtering**: Use file path patterns to identify log formats in Elasticsearch/Kibana

## Testing Patterns

Use the Grok Debugger in Kibana or online tools to test these patterns with sample log data from your log generator.
